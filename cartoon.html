<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="canvas">
  <meta name="author" content="hoskra">
  <script src="lib/p5.min.js" type="text/javascript" defer></script>
  <title>play-texture</title>
  <style>
    body {
      margin: 0;
      font-family: 'Courier New', Courier, monospace;
      padding-left: 10px;
    }
    header {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
    }
    main {
      max-width: 1000px;
      margin: 0 auto;
      display: grid; grid-template-columns: 1fr 1fr;
    }
    #transitionsContainer {
      font-size: 10px;
      list-style: none;
      width: 300px;
    }
    #canvasContainer {
      padding-bottom: 1em;
    }
    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      row-gap: 1em;
      width: 500px;
      margin: 0 0 0 auto;
    }
    button {
      width: 100px;
      height: 30px;
    }
  </style>
</head>
<body>
    <header>
      <h1>Video Texture Player</h1>
      <a href="home.html">switch to clock</a>
    </header>
    <main>

      <div id="player">
        <div id="canvasContainer"></div>
        <div class="controls">
          <div class="tint">
            <h3>Crossfade frames option</h3>
            <input type="radio" name="tint" id="NoTint" value="NoTint" checked="checked"/> <label for="NoTint">No Crossfading</label><br />
            <input type="radio" name="tint" id="Tint" value="Tint" /> <label for="Tint">Crossfading</label><br />
            <input type="radio" name="tint" id="HugeTint" value="HugeTint" /> <label for="HugeTint">Super Crossfading</label><br />
          </div>
          <div class="automatic">
            <h3>Player option</h3>
            <input type="radio" name="automatic" id="Linear" value="Linear" checked="checked"/> <label for="Linear">Linear</label><br />
            <input type="radio" name="automatic" id="Random" value="Random" /> <label for="Random">Random</label><br />
            <input type="radio" name="automatic" id="None" value="None" /> <label for="None">None</label><br />
          </div>
          <p>Current frame: <span id="frame">0</span></p>
          <button id="jump">random jump</button>
        </div>
      </div>
      <div>
        <h3>List of transitions</h3>
        <ul id="transitionsContainer"></ul>
      </div>
    </main>

  </body>
<script>

  const skeleton = {
    filename: "skeleton_dance_6_0.999_2_0.9__F:125_T:1025.txt",
    folder: "skeleton_dance",
    extension: "jpg",
    from: 950,
    to: 1020,
    slice: true
  }
  const clock = {
    filename: "clock_2_0.999_2_0.5__F:37_T:37.txt",
    folder: "clock",
    extension: "png",
    from: 1,
    to: 37,
    slice: false
  }
  const cartoon = {
    filename: "cartoon_3_0.999_2_0.6__F:137_T:137.txt",
    folder: "cartoon",
    extension: "bmp",
    from: 1301,
    to: 1437,
    slice: false
  }

let choice = cartoon;

let TOGGLE = true;
let RANDOM = false;
let TINT = false;
let HUGE_TINT = false;
let W = 640
let H = 480
let f = 0
let i = 0
let images_array = []
let from = choice.from;
let to = choice.to;
let frame_cnt = to - from;

let frame_id = document.getElementById('frame');
let transitions = [];
let transitions_container = document.getElementById('transitionsContainer')
let file_name = choice['filename'];

let jump = document.getElementById('jump')
let Linear = document.getElementById("Linear")
let Random = document.getElementById("Random")
let None = document.getElementById("None")

Linear.onclick = (e=>{ TOGGLE = true; RANDOM = false; })
Random.onclick = (e=>{ TOGGLE = false; RANDOM = true; })
None.onclick = (e=>{ TOGGLE = false; RANDOM = false; })

let Tint = document.getElementById("Tint")
let HugeTint = document.getElementById("HugeTint")
let NoTint = document.getElementById("NoTint")

Tint.onclick = (e=>{ TINT = true; HUGE_TINT = false; })
HugeTint.onclick = (e=>{ TINT = false; HUGE_TINT = true; })
NoTint.onclick = (e=>{ TINT = false; HUGE_TINT = false; })

jump.onclick = function() {
  let len = transitions[i].length;
  if (len && Math.random() > 0.5) {
    i = transitions[i][Math.floor(Math.random() * len)];
  } else {
    i++;
  }
}

function readTextFile(file) {
  var rawFile = new XMLHttpRequest();
  rawFile.open("GET", file, false);
  rawFile.onreadystatechange = function () {
    if(rawFile.readyState === 4) {
      if(rawFile.status === 200 || rawFile.status == 0) {
      var allText = rawFile.responseText.split("\n")

      // slicing means not taking all frames from folder
      if(choice.slice) allText = allText.slice(from, to)

      // loop list of transitions
      allText.forEach((t,i) => {

        // appending to list
        let li = document.createElement('li')
        li.innerHTML = i + ":\t";
        li.id = i;
        transitions_container.appendChild(li)

        // loop transitions
        t = t.slice(1, t.length - 1)
        if(!t) {
          transitions.push([])
        } else {
          transitions.push(

            (choice.slice) ?
              t.split(",")
              .map(x => { return (x >= from && x <= to) ?  x - from : undefined})
              .filter(x => x !== undefined)
            :
              t.split(",")
              .map(x => { return parseInt(x) })
            );

            transitions[i].forEach(e => {
              li.innerHTML += e += " "
            });
          }
        });
      }
    }
  }
  rawFile.send(null);
}

readTextFile(file_name);

function preload() {
  // load images
  for(let i = from; i < to; i++){
    let id = i;
    if (id < 10) { id = '000' + id;
    } else if (id < 100) { id = '00' + id;
    } else if (id < 1000) { id = '0' + id; }
    let image_name = choice['folder'] +"/" + id + "." + choice['extension'];
    images_array.push(loadImage(image_name));
  }
}

function setup() {
  let canvas = createCanvas(W, H);
  canvas.parent("canvasContainer");
}

let previousLi = document.getElementById("0")
function draw() {

  // play video naturally
  if(TOGGLE && frameCount % 4 == 0) {
    i++;
    i %= frame_cnt
  }

  // jump randomly
  if(RANDOM && frameCount % 8 == 0) {
    let len = transitions[i].length;
    if (len) {
      i = transitions[i][Math.floor(Math.random() * len)];
    } else {
      i++;
    }
  }

  push();
  translate(W/2, H/2);

  // color current frame
  frame_id.innerHTML = i;
  li = document.getElementById(i);
  previousLi. style.backgroundColor = 'white';
  li. style.backgroundColor = 'cyan';
  previousLi = li;

  // draw image in center
  if(TINT) {
    tint(255, 67);
  } else if(HUGE_TINT) {
    tint(255, 27);
  }
  image(images_array[i], -images_array[0].width/2, -images_array[0].height/2);
  pop();
}

</script>
</html>
